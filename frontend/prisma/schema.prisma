// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  OWNER
  ORG_ADMIN
  APPRAISER
  CLIENT_VIEWER
}

enum ValuationStatus {
  DRAFT
  IN_PROGRESS
  READY
  SIGNED
  ARCHIVED
}

enum DocumentType {
  TABU
  CONDO
  PERMIT
  PLANNING_INFO
  GARMUSHKA
  GIS_SCREENSHOT
  PROPERTY_IMAGE
  OTHER
}

enum DocumentSource {
  USER_UPLOAD
  APP_GENERATED
  AI_EXTRACTED
}

enum RoomType {
  LIVING
  KITCHEN
  BATH
  BEDROOM
  EXTERIOR
  OTHER
}

enum FinishLevel {
  BASIC
  STANDARD
  PREMIUM
}

enum AssetType {
  PDF
  DOCX
  CSV
  JSON
  IMAGE
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  EXPIRED
}

// Core Authentication & Organization Models
model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  valuations  Valuation[]
  documents   Document[]
  images      Image[]
  assets      Asset[]
  activities  ActivityLog[]
  sessions    ValuationSession[]

  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  valuations  Valuation[]
  activities  ActivityLog[]

  @@map("users")
}

model Membership {
  id             String         @id @default(cuid())
  userId         String
  organizationId String
  role           MembershipRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
}

// Core Valuation System
model Valuation {
  id             String          @id @default(cuid())
  title          String
  status         ValuationStatus @default(DRAFT)
  addressFull    String
  block          String?         // גוש
  parcel         String?         // חלקה
  subparcel      String?         // תת
  meta           Json?
  createdById    String
  organizationId String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Wizard Step Data
  step1Data      Json?           // Initial data from Step 1
  step2Data      Json?           // Documents from Step 2
  step3Data      Json?           // Validation from Step 3
  step4Data      Json?           // AI Analysis from Step 4
  step5Data      Json?           // Export data from Step 5

  // GIS Data
  gisScreenshots Json?           // GIS map screenshots with annotations
  gisAnalysis    Json?           // GIS analysis results

  // Garmushka Data
  garmushkaMeasurements Json?    // Garmushka measurement data
  garmushkaImages       Json?    // Garmushka images and measurements

  // Final Results
  finalValuation    Float?
  pricePerSqm       Float?
  comparableData    Json?         // Comparable sales data
  propertyAnalysis  Json?         // Property analysis results

  createdBy    User         @relation(fields: [createdById], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]
  images       Image[]
  assets       Asset[]
  sessions     ValuationSession[]

  @@index([organizationId])
  @@index([status])
  @@map("valuations")
}

// Session Management for Wizard
model ValuationSession {
  id          String       @id @default(cuid())
  sessionId   String       @unique
  valuationId String?
  organizationId String
  userId      String
  status      SessionStatus @default(ACTIVE)
  stepData    Json?        // Current step data
  wizardData  Json?        // Complete wizard data
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  expiresAt   DateTime?

  valuation   Valuation?   @relation(fields: [valuationId], references: [id], onDelete: SetNull)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([valuationId])
  @@index([organizationId])
  @@index([status])
  @@map("valuation_sessions")
}

// Document Management
model Document {
  id             String         @id @default(cuid())
  valuationId    String?
  organizationId String
  docType        DocumentType
  fileName       String
  storageKey     String
  sha256         String
  source         DocumentSource
  extracted      Json?
  uploadedById   String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  valuation   Valuation?   @relation(fields: [valuationId], references: [id], onDelete: Cascade)

  @@unique([valuationId, docType, sha256])
  @@index([organizationId])
  @@index([docType])
  @@index([sha256])
  @@map("documents")
}

// Image Management
model Image {
  id             String      @id @default(cuid())
  valuationId    String?
  organizationId String
  fileName       String
  storageKey     String
  sha256         String
  roomType       RoomType
  features       Json?
  finishLevel    FinishLevel?
  uploadedById   String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  valuation   Valuation?   @relation(fields: [valuationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([roomType])
  @@index([sha256])
  @@map("images")
}

// Asset Management
model Asset {
  id             String    @id @default(cuid())
  valuationId    String?
  organizationId String
  assetType      AssetType
  fileName       String
  storageKey     String
  sha256         String
  slug           String?
  generatedById  String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  valuation   Valuation?   @relation(fields: [valuationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([assetType])
  @@index([sha256])
  @@map("assets")
}

// Activity Logging
model ActivityLog {
  id             String   @id @default(cuid())
  organizationId String
  subjectType    String   // 'valuation', 'document', 'image', 'asset', 'session'
  subjectId      String
  action         String   // 'created', 'updated', 'deleted', 'uploaded', 'generated', 'completed'
  actorId        String
  payload        Json?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor       User         @relation(fields: [actorId], references: [id])

  @@index([organizationId])
  @@index([subjectType, subjectId])
  @@index([createdAt])
  @@map("activity_logs")
}

// Outbox Pattern for Event Processing
model Outbox {
  id        String   @id @default(cuid())
  eventType String
  payload   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([processed])
  @@map("outbox")
}