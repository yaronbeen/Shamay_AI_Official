{
  "$schema": "http://json-schema.org/draft/2020-12/schema",
  "$id": "https://shamay.ai/schemas/valuation-report.json",
  "title": "Shamay.AI Valuation Report Schema",
  "description": "JSON Schema for Hebrew real estate valuation reports",
  "type": "object",
  "required": [
    "שם_מזמין",
    "מועד_ביקור", 
    "תאריך_קובע",
    "גוש",
    "חלקה",
    "תת",
    "שטח_רשום"
  ],
  "properties": {
    "שם_מזמין": {
      "type": "string",
      "minLength": 2,
      "maxLength": 100,
      "source": "manual",
      "lineage": "קלט שמאי - שדה חובה בשלב 1",
      "qc": {
        "severity": "block",
        "message_he": "שם מזמין חובה",
        "fieldRefs": ["שם_מזמין"]
      }
    },
    "מועד_ביקור": {
      "type": "string",
      "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$",
      "source": "manual",
      "lineage": "קלט שמאי - ברירת מחדל היום",
      "qc": {
        "severity": "block",
        "message_he": "מועד ביקור חייב להיות ≤ היום",
        "fieldRefs": ["מועד_ביקור"]
      }
    },
    "תאריך_קובע": {
      "type": "string", 
      "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$",
      "source": "manual",
      "lineage": "עותק מועד ביקור (עריכה חריגה)",
      "qc": {
        "severity": "block",
        "message_he": "תאריך קובע חייב ≤ היום",
        "fieldRefs": ["תאריך_קובע"]
      }
    },
    "מספר_שומה": {
      "type": "string",
      "pattern": "^\\d{4}_[א-ת0-9]+$",
      "source": "computed",
      "lineage": "Auto-Generated - רץ מ-1000 ומעלה, תבנית ####_{{כתובת}}",
      "qc": {
        "severity": "info",
        "message_he": "מספר שומה נוצר אוטומטית",
        "fieldRefs": ["מספר_שומה"]
      }
    },
    "כתובת": {
      "type": "string",
      "minLength": 10,
      "source": "computed",
      "lineage": "בנייה אוטומטית (רחוב, מס', שכונה, עיר)",
      "qc": {
        "severity": "warn",
        "message_he": "כתובת חייבת להכיל לפחות 10 תווים",
        "fieldRefs": ["כתובת"]
      }
    },
    "רחוב": {
      "type": "string",
      "minLength": 2,
      "source": "manual",
      "lineage": "קלט שמאי"
    },
    "מס_בניין": {
      "type": "string",
      "pattern": "^\\d+$",
      "source": "manual", 
      "lineage": "קלט שמאי"
    },
    "שכונה": {
      "type": "string",
      "source": "manual",
      "lineage": "קלט שמאי (אופציונלי)"
    },
    "עיר": {
      "type": "string",
      "minLength": 2,
      "source": "manual",
      "lineage": "קלט שמאי"
    },
    "מהות_הנכס": {
      "type": "string",
      "enum": ["דירת מגורים", "דירת גג", "דופלקס", "נטהאוז", "סטודיו", "וילה"],
      "source": "manual",
      "lineage": "קלט שמאי"
    },
    "מספר_חדרים": {
      "type": "string",
      "pattern": "^\\d+(\\.\\d+)?$",
      "source": "manual",
      "lineage": "קלט שמאי"
    },
    "קומה": {
      "type": "string",
      "pattern": "^\\d+(\\+\\d+)?$",
      "source": "manual",
      "lineage": "קלט שמאי"
    },
    "כיווני_אוויר": {
      "type": "string",
      "source": "manual",
      "lineage": "קלט שמאי (רשות)"
    },
    "גוש": {
      "type": "string",
      "pattern": "^\\d+$",
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו",
      "qc": {
        "severity": "block",
        "message_he": "גוש חובה",
        "fieldRefs": ["גוש"]
      }
    },
    "חלקה": {
      "type": "string", 
      "pattern": "^\\d+$",
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו",
      "qc": {
        "severity": "block",
        "message_he": "חלקה חובה",
        "fieldRefs": ["חלקה"]
      }
    },
    "תת": {
      "type": "string",
      "pattern": "^\\d+$",
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו",
      "qc": {
        "severity": "block",
        "message_he": "תת חלקה חובה",
        "fieldRefs": ["תת"]
      }
    },
    "שטח_רשום": {
      "type": "number",
      "minimum": 0,
      "maximum": 10000,
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו",
      "qc": {
        "severity": "block",
        "message_he": "שטח רשום חובה",
        "fieldRefs": ["שטח_רשום"]
      }
    },
    "שטח_בנוי": {
      "type": "number",
      "minimum": 0,
      "maximum": 10000,
      "source": "manual",
      "lineage": "קלט/גרפי"
    },
    "שטח_מרפסת": {
      "type": "number",
      "minimum": 0,
      "maximum": 1000,
      "source": "manual",
      "lineage": "קלט שמאי / מדידה גרפית"
    },
    "הצמדות": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו"
    },
    "תקציר_הצמדות": {
      "type": "string",
      "source": "computed",
      "lineage": "נבנה מרשימת הצמדות"
    },
    "זכויות": {
      "type": "string",
      "enum": ["בעלות פרטית", "חכירה", "זכות שימוש"],
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו"
    },
    "לשכה": {
      "type": "string",
      "source": "ocr:tabu",
      "lineage": "שם לשכת רישום"
    },
    "תאריך_נסח": {
      "type": "string",
      "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$",
      "source": "ocr:tabu",
      "lineage": "תאריך הפקת הנסח"
    },
    "שטח_חלקה": {
      "type": "number",
      "minimum": 50,
      "maximum": 50000,
      "source": "ocr:tabu",
      "lineage": "נשלף אוטומטית מנסח טאבו"
    },
    "צורת_חלקה": {
      "type": "string",
      "enum": ["מלבן", "טרפז", "אי-רגולרי"],
      "source": "manual",
      "lineage": "קלט ידני / AI (Shape classifier)"
    },
    "פני_קרקע": {
      "type": "string",
      "enum": ["מישוריים", "משופעים", "מדורגים"],
      "source": "manual",
      "lineage": "קלט ידני / AI"
    },
    "מספר_קומות": {
      "type": "integer",
      "minimum": 1,
      "maximum": 20,
      "source": "ocr:condo",
      "lineage": "נשלף אוטומטית מצו בית משותף"
    },
    "מספר_יחידות": {
      "type": "integer",
      "minimum": 1,
      "maximum": 100,
      "source": "ocr:condo",
      "lineage": "נשלף אוטומטית מצו בית משותף"
    },
    "שנת_בניה": {
      "type": "integer",
      "minimum": 1900,
      "maximum": 2030,
      "source": "ocr:permit",
      "lineage": "נשלף אוטומטית מהיתר בניה"
    },
    "היתר_עדכני": {
      "type": "object",
      "properties": {
        "מספר": {
          "type": "string",
          "minLength": 4,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מהיתר בניה"
        },
        "תאריך": {
          "type": "string",
          "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$",
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מהיתר בניה"
        },
        "תיאור": {
          "type": "string",
          "minLength": 10,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מהיתר בניה"
        }
      },
      "required": ["מספר", "תאריך"],
      "source": "ocr:permit",
      "lineage": "היתר הבניה העדכני ביותר"
    },
    "היתרים": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "מספר": {
            "type": "string",
            "minLength": 4
          },
          "תאריך": {
            "type": "string",
            "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$"
          },
          "תיאור": {
            "type": "string",
            "minLength": 10
          }
        },
        "required": ["מספר", "תאריך", "תיאור"]
      },
      "source": "ocr:permit",
      "lineage": "רשימת כל היתרי הבניה"
    },
    "תכניות": {
      "type": "array",
      "minItems": 5,
      "items": {
        "type": "object",
        "properties": {
          "מספר": {
            "type": "string",
            "minLength": 3
          },
          "יפ": {
            "type": "integer",
            "minimum": 1
          },
          "תאריך": {
            "type": "string",
            "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$"
          },
          "מהות": {
            "type": "string",
            "minLength": 5
          }
        },
        "required": ["מספר", "תאריך"]
      },
      "source": "manual",
      "lineage": "קלט ידני - לפחות 5 תכניות"
    },
    "זכויות_בניה": {
      "type": "object",
      "properties": {
        "יעוד": {
          "type": "string",
          "enum": ["מגורים", "תעסוקה", "מסחר", "ציבורי"],
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "שטח_מגרש": {
          "type": "integer",
          "minimum": 1,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "מספר_קומות": {
          "type": "string",
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "אחוזי_בניה": {
          "type": "integer",
          "minimum": 0,
          "maximum": 800,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "רוחב_חזית": {
          "type": "number",
          "minimum": 0,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "גובה_קומות": {
          "type": "number",
          "minimum": 2.6,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "קווי_בניין": {
          "type": "string",
          "minLength": 5,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        },
        "חדר_יציאה_גג": {
          "type": "integer",
          "minimum": 0,
          "source": "ocr:permit",
          "lineage": "נשלף אוטומטית מדף מידע תכנוני"
        }
      },
      "required": ["יעוד", "שטח_מגרש", "מספר_קומות"],
      "source": "ocr:permit",
      "lineage": "נשלף אוטומטית מדף מידע תכנוני"
    },
    "חשד_זיהום": {
      "type": "boolean",
      "source": "manual",
      "lineage": "קלט שמאי - Checkbox"
    },
    "פירוט_זיהום": {
      "type": "string",
      "minLength": 4,
      "maxLength": 120,
      "source": "manual",
      "lineage": "קלט שמאי - חובה אם חשד_זיהום = true"
    },
    "סטנדרט_גמר": {
      "type": "string",
      "enum": ["Basic", "Standard", "Premium"],
      "source": "ai:cv",
      "lineage": "AI Classifier + Override שמאי"
    },
    "שווי_אקוו": {
      "type": "number",
      "minimum": 0,
      "source": "computed",
      "lineage": "חישוב אוטומטי על בסיס נתוני השוואה"
    },
    "שווי_מעוגל": {
      "type": "number",
      "minimum": 0,
      "source": "computed",
      "lineage": "עיגול לתקינות של 1,000₪"
    },
    "שווי_מעוגל_מילים": {
      "type": "string",
      "source": "computed",
      "lineage": "המרה למילים בעברית"
    },
    "מקדם_מרפסת": {
      "type": "number",
      "default": 0.5,
      "source": "manual",
      "lineage": "מקדם אקוויוולנטי למרפסת"
    },
    "עסקאות": {
      "type": "array",
      "minItems": 3,
      "items": {
        "type": "object",
        "properties": {
          "תאריך": {
            "type": "string",
            "pattern": "^\\d{2}\\.\\d{2}\\.\\d{4}$"
          },
          "כתובת": {
            "type": "string"
          },
          "גוש": {
            "type": "string"
          },
          "חלקה": {
            "type": "string"
          },
          "חדרים": {
            "type": "string"
          },
          "קומה": {
            "type": "string"
          },
          "שטח": {
            "type": "number"
          },
          "מרפסת": {
            "type": "number"
          },
          "אקוו": {
            "type": "number"
          },
          "מחיר": {
            "type": "number"
          },
          "מחיר_למ2": {
            "type": "number"
          }
        }
      },
      "source": "manual",
      "lineage": "קלט ידני - לפחות 3 עסקאות"
    },
    "היצע": {
      "type": "array",
      "minItems": 2,
      "items": {
        "type": "object",
        "properties": {
          "כתובת": {
            "type": "string"
          },
          "חדרים": {
            "type": "string"
          },
          "קומה": {
            "type": "string"
          },
          "שטח": {
            "type": "number"
          },
          "מרפסת": {
            "type": "number"
          },
          "אקוו": {
            "type": "number"
          },
          "מחיר": {
            "type": "number"
          },
          "מחיר_למ2": {
            "type": "number"
          }
        }
      },
      "source": "manual",
      "lineage": "קלט ידני - לפחות 2 נכסים"
    }
  },
  "additionalProperties": false
}
